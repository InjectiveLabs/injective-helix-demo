<script lang="ts" setup>
import { formatWalletAddress } from '@injectivelabs/utils'
import { Modal } from '@/types'

const modalStore = useModalStore()
const walletStore = useWalletStore()
const ninjaPassStore = useNinjaPassStore()
const confetti = useConfetti()
const router = useRouter()

const props = defineProps({
  isSidebarOpen: Boolean
})

const emit = defineEmits<{
  'sidebar:closed': []
  'sidebar:opened': []
}>()

const isUserConnectedProcessCompleted = ref(false)

const hasNinjaPassCodes = computed(() => {
  if (!ninjaPassStore.codes) {
    return false
  }

  return ninjaPassStore.codes.length > 0
})

watch(
  () => walletStore.isUserWalletConnected,
  (newIsUserWalletConnected) => {
    if (!newIsUserWalletConnected) {
      isUserConnectedProcessCompleted.value = false
    }
  }
)

onMounted(() => {
  if (walletStore.isUserWalletConnected) {
    isUserConnectedProcessCompleted.value = true
  }
})

function toggleSidebar() {
  if (props.isSidebarOpen) {
    return emit('sidebar:closed')
  }

  emit('sidebar:opened')
}

function showNinjaPassModal() {
  modalStore.openModal({ type: Modal.NinjaPassWinner })

  confetti.showConfetti()
}

function resetAuthZ() {
  if (walletStore.isAuthzWalletConnected) {
    walletStore.resetAuthZ()
    /**
     * -- TODO --
     * For now, we reload the page to refetch everything on the
     * page but we should add watchers for better UX
     */
    location.reload()
  }
}
</script>

<template>
  <header
    class="w-full z-40 h-12 lg:h-14 bg-gray-1000 flex items-center border-b border-b-gray-900"
    :class="{
      fixed: isSidebarOpen,
      relative: !isSidebarOpen
    }"
  >
    <div
      class="cursor-pointer pl-6 lg:pr-6 lg:border-r flex items-center"
      @click="router.push({ name: 'index' })"
    >
      <AssetLogo class="w-auto h-6 lg:h-[30px]" alt="Helix" />
    </div>
    <div class="flex-1 px-2 lg:px-6 flex justify-end lg:justify-between">
      <div
        class="relative h-0 -z-10 w-0 opacity-0 lg:h-full lg:z-0 lg:w-full lg:opacity-100 flex items-center"
      >
        <LayoutNav class="hidden lg:block" />
      </div>
      <div class="flex items-center">
        <LayoutNavItemDummy
          v-if="walletStore.isUserWalletConnected && hasNinjaPassCodes"
          class="flex px-0 w-10 items-center justify-center"
          @click="showNinjaPassModal"
        >
          <BaseIcon name="gift" class="text-white w-4 h-4" />
        </LayoutNavItemDummy>

        <LayoutNavItem
          v-if="walletStore.isUserWalletConnected"
          class="hidden lg:flex"
          data-cy="header-activity-link"
          :to="{ name: 'activity' }"
        >
          {{ $t('navigation.activity') }}
        </LayoutNavItem>

        <LayoutNavItem
          v-if="walletStore.isUserWalletConnected"
          class="hidden lg:flex"
          data-cy="header-account-link"
          :to="{ name: 'account' }"
        >
          {{ $t('navigation.account') }}
        </LayoutNavItem>

        <LayoutNavItemDummy
          v-if="walletStore.isAuthzWalletConnected"
          class="hidden lg:flex px-0 w-12 items-center justify-center"
          @click="resetAuthZ"
        >
          <AppTooltip
            :content="
              $t('navigation.connectedUsingAuthZ', {
                address: formatWalletAddress(walletStore.authZ.injectiveAddress)
              })
            "
          >
            <BaseIcon
              name="spy"
              class="text-white w-4 h-4 hover:text-red-500"
            />
          </AppTooltip>
        </LayoutNavItemDummy>

        <LayoutWallet />

        <LayoutNavItemDummy
          v-if="walletStore"
          class="hidden lg:flex px-0 w-10 items-center justify-center"
          @click="() => {}"
        >
          <LayoutPreferences v-if="walletStore.isUserWalletConnected" />
        </LayoutNavItemDummy>
      </div>
    </div>
    <button
      class="px-4 border-r border-gray-600 text-gray-200 lg:hidden"
      @click.stop="toggleSidebar"
    >
      <BaseIcon v-if="isSidebarOpen" name="close" class="w-6 h-6" />
      <BaseIcon v-else name="menu" class="w-6 h-6" />
    </button>
  </header>
</template>
