<script lang="ts" setup>
import { PropType } from 'vue'
import { UiSpotMarketWithToken, SpotOrderSide } from '@injectivelabs/sdk-ui-ts'
import { BigNumberInBase } from '@injectivelabs/utils'
import { AccountBalance, Modal, TradeField, TradeForm } from '@/types'
import { TRADE_FORM_PRICE_ROUNDING_MODE } from '@/app/utils/constants'
import { usdcTokenDenom } from '@/app/data/token'

const accountStore = useAccountStore()
const modalStore = useModalStore()
const formValues = useFormValues<TradeForm>()

const props = defineProps({
  isLoading: Boolean,
  isBaseAmount: Boolean,

  market: {
    type: Object as PropType<UiSpotMarketWithToken>,
    required: true
  },

  balances: {
    type: Object as PropType<AccountBalance[]>,
    required: true
  },

  worstPriceWithSlippage: {
    type: Object as PropType<BigNumberInBase>,
    required: true
  }
})

const emit = defineEmits<{
  (e: 'update:isBaseAmount', state: boolean): void
  (
    e: 'update:amount',
    { amount, isBaseAmount }: { amount: string; isBaseAmount: boolean }
  ): void
}>()

const animationCount = ref(0)

const { takerFeeRate } = useTradeFee(computed(() => props.market))

const baseBalance = computed(() =>
  props.balances.find(
    (balance) => balance.token.denom === props.market.baseDenom
  )
)

const baseBalanceToBase = computed(() =>
  new BigNumberInBase(baseBalance.value?.availableMargin || 0).toWei(
    baseBalance.value?.token.decimals
  )
)

const quoteBalance = computed(() =>
  props.balances.find(
    (balance) => balance.token.denom === props.market.quoteDenom
  )
)

const quoteBalanceToBase = computed(() =>
  new BigNumberInBase(quoteBalance.value?.availableMargin || 0).toWei(
    quoteBalance.value?.token.decimals
  )
)

const isWHSolUSDTBaseDenom = computed(
  () => props.market.baseDenom === usdcTokenDenom.USDCso
)

const isBuy = computed(() => orderType.value === SpotOrderSide.Buy)

const { valueToFixed: maxBalanceToFixed } = useBigNumberFormatter(
  computed(() => baseBalance.value?.availableMargin),
  {
    decimalPlaces: props.market?.quantityDecimals
  }
)

const { value: orderType, setValue: setOrderType } = useStringField({
  name: TradeField.OrderType,
  initialValue: SpotOrderSide.Sell
})

watch(
  () => props.worstPriceWithSlippage,
  () => {
    emit('update:amount', {
      amount: props.isBaseAmount
        ? formValues.value[TradeField.BaseAmount]
        : formValues.value[TradeField.QuoteAmount],
      isBaseAmount: props.isBaseAmount
    })
  }
)

onMounted(() => {
  if (!accountStore.hasEnoughInjForGas) {
    modalStore.openModal({ type: Modal.InsufficientInjForGas })
  }

  if ([usdcTokenDenom.USDC].includes(baseBalance.value?.denom || '')) {
    handleMaxBaseAmountChange({
      amount: maxBalanceToFixed.value
    })
  }
})

function toggleOrderType() {
  setOrderType(isBuy.value ? SpotOrderSide.Sell : SpotOrderSide.Buy)
}

function handleSwap() {
  if (!isWHSolUSDTBaseDenom.value) {
    return
  }

  animationCount.value = animationCount.value + 1

  emit('update:isBaseAmount', !props.isBaseAmount)

  formValues.value[TradeField.BaseAmount] = ''
  formValues.value[TradeField.QuoteAmount] = ''

  toggleOrderType()
}

function updateAmount({
  amount,
  isBaseAmount
}: {
  amount: string
  isBaseAmount: boolean
}) {
  emit('update:amount', { amount, isBaseAmount })
}

function handleMaxBaseAmountChange({ amount }: { amount: string }) {
  formValues.value[TradeField.BaseAmount] = amount

  updateAmount({ amount, isBaseAmount: true })
}

function handleMaxQuoteAmountChange({ amount }: { amount: string }) {
  const amountInBigNumber = new BigNumberInBase(amount)

  const feeRateToDeduct = amountInBigNumber.times(takerFeeRate.value)
  const amountDeductFee = amountInBigNumber.minus(feeRateToDeduct)

  const amountDeductFeeToFixed = amountDeductFee.toFixed(
    props.market.priceDecimals,
    TRADE_FORM_PRICE_ROUNDING_MODE
  )

  formValues.value[TradeField.BaseAmount] = amountDeductFeeToFixed

  emit('update:amount', { amount: amountDeductFeeToFixed, isBaseAmount: false })
}
</script>

<template>
  <div class="flex flex-col">
    <transition :name="!isBuy ? 'fade-up' : 'fade-down'" mode="out-in">
      <div
        :key="`animation-${animationCount}`"
        :class="[!isBuy ? 'order-first' : 'order-last']"
      >
        <div
          class="flex justify-between mb-2"
          :class="!isBuy ? 'order-first' : 'order-last'"
        >
          <span class="font-semibold">{{
            !isBuy ? $t('account.from') : $t('account.to')
          }}</span>

          <ModalsConvertUsdcTokenFormPill
            v-if="baseBalance"
            :balance="baseBalance"
          />
        </div>

        <AppSelectToken
          v-if="baseBalance"
          v-bind="{
            denom: baseBalance.denom,
            amountFieldName: TradeField.BaseAmount,
            disabled: isLoading,
            required: !isBuy,
            hideMax: isBuy,
            maxDecimals: market?.quantityDecimals,
            options: [
              {
                token: baseBalance.token,
                denom: baseBalance.denom,
                balance: baseBalanceToBase.toFixed()
              }
            ]
          }"
          @update:amount="updateAmount"
          @update:max="handleMaxBaseAmountChange"
        >
          <span>
            {{ $t(`trade.convert.${isBuy ? 'youReceive' : 'youPay'}`) }}
          </span>
        </AppSelectToken>
      </div>
    </transition>

    <div
      class="flex items-center justify-center my-4 mx-auto bg-blue-500 h-8 w-8 rounded-full"
    >
      <BaseIcon
        :name="isWHSolUSDTBaseDenom ? 'arrow-up-down' : 'arrow'"
        class="mx-auto h-5 w-5"
        :class="{
          '-rotate-90': !isWHSolUSDTBaseDenom,
          'ml-2': isWHSolUSDTBaseDenom
        }"
        @click="handleSwap"
      />
    </div>

    <transition :name="!isBuy ? 'fade-down' : 'fade-up'" mode="out-in">
      <div
        :key="`animation-${animationCount}`"
        :class="[!isBuy ? 'order-last' : 'order-first']"
      >
        <div
          class="flex justify-between mb-2"
          :class="!isBuy ? 'order-last' : 'order-first'"
        >
          <span class="font-semibold">{{
            isBuy ? $t('account.from') : $t('account.to')
          }}</span>
          <ModalsConvertUsdcTokenFormPill
            v-if="quoteBalance"
            :balance="quoteBalance"
          />
        </div>

        <AppSelectToken
          v-if="quoteBalance"
          v-bind="{
            denom: quoteBalance.denom,
            amountFieldName: TradeField.QuoteAmount,
            disabled: isLoading,
            required: isBuy,
            hideMax: !isBuy,
            maxDecimals: market?.quantityDecimals,
            options: [
              {
                token: quoteBalance.token,
                denom: quoteBalance.denom,
                balance: quoteBalanceToBase.toFixed()
              }
            ]
          }"
          @update:amount="updateAmount"
          @update:max="handleMaxQuoteAmountChange"
        >
          <span>
            {{ $t(`trade.convert.${isBuy ? 'youPay' : 'youReceive'}`) }}
          </span>
        </AppSelectToken>
      </div>
    </transition>
  </div>
</template>
